# Data Model: Power Screen Enhancements

**Feature**: Power Screen Enhancements  
**Branch**: `001-power-screen-enhancements`  
**Date**: 2025-12-13

## Overview

This document defines the data structures, constants, and state management for the power screen enhancements feature. All structures are designed for embedded systems with minimal dynamic allocation and PROGMEM usage where applicable.

---

## Color Constants

### Purpose
Define the exact hex color values for power state visualization as specified in the requirements.

### Structure

```cpp
// File: src/app/screen_power.cpp (file scope, PROGMEM-friendly)

// Color definitions for power state visualization
const lv_color_t COLOR_BRIGHT_GREEN = lv_color_hex(0x00FF00);  // Bright green
const lv_color_t COLOR_WHITE        = lv_color_hex(0xFFFFFF);  // White
const lv_color_t COLOR_ORANGE       = lv_color_hex(0xFFA500);  // Orange
const lv_color_t COLOR_RED          = lv_color_hex(0xFF0000);  // Red
```

### Rationale
- `const` keyword places in flash (PROGMEM) on ESP32
- `lv_color_t` is LVGL's native color type (RGB565 for 16-bit displays)
- `lv_color_hex()` macro converts 24-bit RGB to display format at compile time
- File scope limits visibility to screen_power.cpp, prevents namespace pollution

---

## Icon Asset Structures

### Purpose
Represent converted PNG icon data in LVGL-compatible format for image widget rendering.

### Generated Structure (from lv_img_conv tool)

```cpp
// File: src/app/icon_assets.h (auto-generated by tools/convert-icons.sh)

#ifndef ICON_ASSETS_H
#define ICON_ASSETS_H

#include <lvgl.h>

// Solar power icon (48x48 RGB565)
extern const lv_img_dsc_t icon_solar;

// Home power icon (48x48 RGB565)
extern const lv_img_dsc_t icon_home;

// Grid power icon (48x48 RGB565)
extern const lv_img_dsc_t icon_grid;

#endif // ICON_ASSETS_H
```

```cpp
// File: src/app/icon_assets.c (auto-generated by tools/convert-icons.sh)

#include "icon_assets.h"

// Solar icon data array
const LV_ATTRIBUTE_MEM_ALIGN LV_ATTRIBUTE_IMG_ICON_SOLAR uint8_t icon_solar_map[] = {
    // ... 4,608 bytes of RGB565 pixel data (48×48×2) ...
};

const lv_img_dsc_t icon_solar = {
    .header.cf = LV_IMG_CF_TRUE_COLOR_ALPHA,
    .header.always_zero = 0,
    .header.reserved = 0,
    .header.w = 48,
    .header.h = 48,
    .data_size = 4608,
    .data = icon_solar_map,
};

// Similar structures for icon_home and icon_grid
```

### Fields

| Field | Type | Description |
|-------|------|-------------|
| `header.cf` | `lv_img_cf_t` | Color format (LV_IMG_CF_TRUE_COLOR_ALPHA for RGB565+alpha) |
| `header.w` | `lv_coord_t` | Image width in pixels (48) |
| `header.h` | `lv_coord_t` | Image height in pixels (48) |
| `data_size` | `uint32_t` | Size of pixel data array in bytes (4,608 for 48×48 RGB565) |
| `data` | `const uint8_t*` | Pointer to pixel data array in flash |

### Memory Layout
- Storage: PROGMEM flash (const arrays)
- Size per icon: ~4.6KB (48×48 pixels × 2 bytes/pixel RGB565)
- Total: ~14KB for 3 icons + metadata
- No heap allocation required

---

## Power Screen Widget State

### Purpose
Extend existing PowerScreen class to track vertical bar chart widgets and enable color/bar updates.

### Extended Class Structure

```cpp
// File: src/app/screen_power.h

class PowerScreen : public ScreenBase {
private:
    // ... existing widgets (solar_icon, solar_value, solar_unit, etc.) ...\n    
    // NEW: Vertical bar chart widgets (12px wide, 120px tall, from Y=120)
    lv_obj_t* solar_bar = nullptr;   // Vertical bar for solar power
    lv_obj_t* home_bar = nullptr;    // Vertical bar for home power
    lv_obj_t* grid_bar = nullptr;    // Vertical bar for grid power

class PowerScreen : public ScreenBase {
public:
    PowerScreen();
    ~PowerScreen();
    
    void create() override;
    void destroy() override;
    void update() override;
    void show() override;
    void hide() override;
    
    // Existing power update methods
    void set_solar_power(float kw);
    void set_grid_power(float kw);

private:
    // Existing UI elements
    lv_obj_t* background = nullptr;
    lv_obj_t* solar_icon = nullptr;
    lv_obj_t* home_icon = nullptr;
    lv_obj_t* grid_icon = nullptr;
    lv_obj_t* arrow1 = nullptr;
    lv_obj_t* arrow2 = nullptr;
    lv_obj_t* solar_value = nullptr;
    lv_obj_t* home_value = nullptr;
    lv_obj_t* grid_value = nullptr;
    lv_obj_t* solar_unit = nullptr;
    lv_obj_t* home_unit = nullptr;
    lv_obj_t* grid_unit = nullptr;
    
    // NEW: Bar chart widgets
    lv_obj_t* solar_bar = nullptr;
    lv_obj_t* home_bar = nullptr;
    lv_obj_t* grid_bar = nullptr;
    
    // Existing power values
    float solar_kw = NAN;
    float grid_kw = NAN;
    
    // Existing helper
    void update_home_value();
    
    // NEW: Color calculation helpers
    lv_color_t get_grid_color(float kw);
    lv_color_t get_home_color(float kw);
    lv_color_t get_solar_color(float kw);
    
    // NEW: Widget update helpers
    void update_power_colors();
    void update_power_bars();
};
```

### New State Fields

| Field | Type | Description |
|-------|------|-------------|
| `solar_bar` | `lv_obj_t*` | LVGL bar widget for solar power visualization |
| `home_bar` | `lv_obj_t*` | LVGL bar widget for home power visualization |
| `grid_bar` | `lv_obj_t*` | LVGL bar widget for grid power visualization |

### State Lifecycle
1. **Initialization**: Widgets created in `create()`, pointers stored
2. **Update**: Bar values set in `set_solar_power()`, `set_grid_power()`, `update_home_value()`
3. **Cleanup**: Widgets deleted in `destroy()`, pointers nulled

---

## Color Threshold Logic

### Purpose
Map power values (float kW) to LVGL color constants based on spec-defined thresholds.

### Grid Power Color Function

```cpp
lv_color_t PowerScreen::get_grid_color(float kw) {
    if (isnan(kw)) return COLOR_WHITE;  // No data state
    if (kw < 0.0f) return COLOR_BRIGHT_GREEN;  // Exporting to grid
    if (kw < 1.0f) return COLOR_WHITE;  // Low import
    if (kw < 2.5f) return COLOR_ORANGE;  // Medium import
    return COLOR_RED;  // High import (≥2.5kW)
}
```

**Thresholds**:
- `< 0` → Bright Green (#00FF00) - Exporting excess solar
- `≥ 0 and < 1kW` → White (#FFFFFF) - Low grid consumption
- `≥ 1kW and < 2.5kW` → Orange (#FFA500) - Medium grid consumption
- `≥ 2.5kW` → Red (#FF0000) - High grid consumption

### Home Power Color Function

```cpp
lv_color_t PowerScreen::get_home_color(float kw) {
    if (isnan(kw)) return COLOR_WHITE;  // No data state
    if (kw < 0.5f) return COLOR_BRIGHT_GREEN;  // Very low consumption
    if (kw < 1.0f) return COLOR_WHITE;  // Low consumption
    if (kw < 2.0f) return COLOR_ORANGE;  // Medium consumption
    return COLOR_RED;  // High consumption (≥2kW)
}
```

**Thresholds**:
- `< 0.5kW` → Bright Green (#00FF00) - Very low home load
- `≥ 0.5kW and < 1kW` → White (#FFFFFF) - Low home load
- `≥ 1kW and < 2kW` → Orange (#FFA500) - Medium home load
- `≥ 2kW` → Red (#FF0000) - High home load

### Solar Power Color Function

```cpp
lv_color_t PowerScreen::get_solar_color(float kw) {
    if (isnan(kw)) return COLOR_WHITE;  // No data state
    if (kw < 0.5f) return COLOR_WHITE;  // Low generation
    return COLOR_BRIGHT_GREEN;  // Good generation (≥0.5kW)
}
```

**Thresholds**:
- `< 0.5kW` → White (#FFFFFF) - Low or no solar generation
- `≥ 0.5kW` → Bright Green (#00FF00) - Active solar generation

### Edge Cases
- **NaN values**: Return WHITE for neutral state (matches existing `--` text behavior)
- **Boundary values**: Use `<` comparison (e.g., 1.0kW exactly → `< 1.0f` returns true, uses lower threshold)
- **Negative home power**: Should not occur (home = grid + solar always ≥ 0), but treated as 0kW

---

## Bar Chart Value Mapping

### Purpose
Convert power values (kW) to bar widget percentage (0-100%) for 0-3kW scale.

### Value Calculation

```cpp
// Convert kW to bar value (0-3000mW range)
int16_t power_to_bar_value(float kw) {
    if (isnan(kw) || kw < 0.0f) return 0;  // No data or negative → empty bar
    float abs_kw = fabsf(kw);  // Use absolute value for negative grid power
    if (abs_kw > 3.0f) abs_kw = 3.0f;  // Clamp to max scale
    return (int16_t)(abs_kw * 1000.0f);  // Convert to milliwatts
}
```

### Bar Configuration
```cpp
// In PowerScreen::create()
lv_bar_set_range(solar_bar, 0, 3000);  // 0-3kW in milliwatts
lv_bar_set_value(solar_bar, power_to_bar_value(solar_kw), LV_ANIM_OFF);
```

### Mapping Examples

| Power Value | Calculation | Bar Value | Visual % |
|-------------|-------------|-----------|----------|
| 0.0 kW | 0.0 × 1000 | 0 | 0% (empty) |
| 1.5 kW | 1.5 × 1000 | 1500 | 50% (half full) |
| 3.0 kW | 3.0 × 1000 | 3000 | 100% (full) |
| 4.5 kW | 3.0 × 1000 (clamped) | 3000 | 100% (full) |
| -1.0 kW (grid export) | abs(-1.0) × 1000 | 1000 | 33% (abs value) |
| NaN | 0 | 0 | 0% (empty) |

---

## Layout Geometry

### Purpose
Define exact pixel positions for bar chart widgets relative to existing power screen layout.

### Screen Coordinate System
- Display resolution: 280×240 (software rotated from 240×280)
- Origin: (0,0) at top-left
- Alignment: `LV_ALIGN_TOP_MID` with X offsets for column positioning

### Column Positions (existing)

| Column | X Offset | Element | Y Position |
|--------|----------|---------|------------|
| Solar (left) | -107 | Icon | 15 |
| Solar (left) | -107 | Value | 80 |
| Solar (left) | -107 | Label | 115 |
| **Solar (left)** | **-107** | **Bar (NEW)** | **140** |
| Home (center) | 0 | Icon | 15 |
| Home (center) | 0 | Value | 80 |
| Home (center) | 0 | Label | 115 |
| **Home (center)** | **0** | **Bar (NEW)** | **140** |
| Grid (right) | +107 | Icon | 15 |
| Grid (right) | +107 | Value | 80 |
| Grid (right) | +107 | Label | 115 |
| **Grid (right)** | **+107** | **Bar (NEW)** | **140** |

### Bar Dimensions
- Width: 60 pixels (fits within column spacing)
- Height: 8 pixels (sufficient visibility, minimal screen space)
- Positioning: `lv_obj_align(bar, LV_ALIGN_TOP_MID, x_offset, 140)`
- Spacing: 25 pixels below "kW" label baseline

### Visual Layout Diagram

```
┌────────────────────────────────────────────────────────────┐
│                   280 × 240 Display                         │
│                                                              │
│ Y=15   [Solar Icon]    [Home Icon]    [Grid Icon]          │
│        (48×48)         (48×48)        (48×48)               │
│                                                              │
│ Y=80   [2.50]          [3.25]         [0.75]                │
│        (32pt)          (32pt)         (32pt)                │
│                                                              │
│ Y=115  kW              kW             kW                     │
│        (14pt)          (14pt)         (14pt)                │
│                                                              │
│ Y=140  [▓▓▓▓▓▓░░░]    [▓▓▓▓▓▓▓▓▓]   [▓▓░░░░░░░]          │
│        60×8px bar     60×8px bar    60×8px bar              │
│        (83% fill)     (100% fill)   (25% fill)              │
│                                                              │
│        X=-107          X=0           X=+107                  │
│         (left)         (center)      (right)                 │
└────────────────────────────────────────────────────────────┘
```

---

## Memory Budget Summary

| Component | Storage | Size | Location |
|-----------|---------|------|----------|
| Color constants (4) | Flash (PROGMEM) | ~16 bytes | screen_power.cpp |
| Icon PNG data (3) | Flash (PROGMEM) | ~13.8 KB | icon_assets.c |
| Icon descriptors (3) | Flash (PROGMEM) | ~300 bytes | icon_assets.c |
| Bar widgets (3) | Heap (LVGL) | ~600 bytes | Runtime |
| Bar styles (3) | Heap (LVGL) | ~300 bytes | Runtime |
| **Total Flash** | | **~14.1 KB** | Within <85% target |
| **Total Heap** | | **~900 bytes** | <2% of 48KB budget |

---

## Data Flow Summary

```
MQTT Update (1Hz)
    ↓
PowerScreen::set_solar_power(kw) / set_grid_power(kw)
    ↓
Update text value (existing)
    ↓
get_solar_color(kw) / get_grid_color(kw) / get_home_color(kw)
    ↓
lv_obj_set_style_text_color(icon/value/label, color)
    ↓
power_to_bar_value(kw) → clamp(abs(kw) * 1000, 0, 3000)
    ↓
lv_bar_set_value(bar, bar_value, LV_ANIM_OFF)
    ↓
LVGL render (60 FPS, non-blocking)
    ↓
Display update via SPI at 60MHz
```

---

## Validation Criteria

### Compile-Time Validation
- [ ] Color constants use `const lv_color_t` for PROGMEM placement
- [ ] Icon assets declared as `extern const lv_img_dsc_t` in header
- [ ] Bar widgets use correct LVGL `lv_bar_*` API (not custom drawing)
- [ ] No dynamic memory allocation in update paths

### Runtime Validation
- [ ] Bar values clamped to 0-3000 range (0-3kW)
- [ ] NaN values handled gracefully (default to white color, empty bar)
- [ ] Negative grid power uses absolute value for bar visualization
- [ ] Color updates occur within 500ms of power value change
- [ ] 60 FPS maintained with bar updates (verified via FPS counter)

### Build-Time Validation
- [ ] PNG files validated as 48×48 pixels before conversion
- [ ] Icon conversion generates valid lv_img_dsc_t structures
- [ ] Generated icon_assets.c compiles without warnings
- [ ] Total flash usage remains <85% after icon addition

---

## Data Model Complete

All data structures, constants, and state management defined. Ready for Phase 1B (contract definitions) and Phase 1C (implementation quickstart).
